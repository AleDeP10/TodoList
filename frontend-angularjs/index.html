<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />

    <!-- favicon -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/icons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/icons/favicon-16x16.png"
    />
    <link rel="manifest" href="/assets/icons/site.webmanifest" />
    <link rel="icon" href="/assets/icons/favicon.ico" />

    <!-- ✅ Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <!-- ✅ AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>

    <!-- ✅ Redux -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.1.2/redux.min.js"></script>
    <script src="lib/ng-redux.min.js"></script>

    <!-- ✅ Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ✅ Custom styles -->
    <link rel="stylesheet" href="style.css" />

    <!-- ✅ WICG inert polyfill -->
    <script src="https://cdn.jsdelivr.net/npm/wicg-inert@latest/dist/inert.min.js"></script>

    <!-- ✅ Store -->
    <script src="store/middleware/logger.js"></script>
    <script src="store/reducers/taskReducer.js"></script>
    <script src="store/configureStore.js"></script>

    <!-- ✅ Utilities -->
    <script src="utils/modalUtils.js"></script>
    <script src="utils/toastUtils.js"></script>

    <!-- ✅ Internationalization -->
    <script src="services/i18nService.js"></script>
    <script src="filters/i18nFilter.js"></script>

    <!-- ✅ ModalContainer -->
    <script src="directives/modalContainer.js"></script>

    <!-- ✅ Data Services -->
    <script src="services/taskService.js"></script>
    <script src="services/userService.js"></script>

    <!-- ✅ Controller -->
    <script src="controllers/taskController.js"></script>

    <!-- ✅ AngularJS App-->
    <script src="app.js"></script>

    <title>Todo List</title>
  </head>

  <body>
    <div id="appRoot" ng-controller="TaskController" class="container">
      <!-- Topbar -->
      <div
        class="topbar bg-gradient-topbar d-flex justify-content-between align-items-center px-4 py-3"
      >
        <div>
          <!-- New task button -->
          <button class="btn btn-success" ng-click="openTaskModal()">
            ➕ {{ labels['task.new'] }}
          </button>

          <!-- Filters button -->
          <button
            class="btn btn-light text-primary fw-semibold"
            ng-click="toggleFilterPanel()"
          >
            {{ showFilterPanel ? labels['filters.hide'] : labels['filters.show']
            }}
          </button>
        </div>

        <!-- Header -->
        <h1 class="h5 text-white m-0">{{ labels['task.header'] }}</h1>

        <div
          class="form-check form-switch d-flex align-items-center gap-2 text-white"
        >
          <!-- Client mode switch -->
          <input
            type="checkbox"
            class="form-check-input"
            id="modeToggle"
            ng-model="filterModeToggle"
            ng-change="switchMode()"
          />
          <label class="form-check-label mb-0" for="modeToggle">
            {{ labels['filters.clientMode'] }}
          </label>

          <!-- Language selector -->
          <div class="btn-group ms-3" role="group" aria-label="Lingua">
            <button
              type="button"
              class="btn btn-outline-light btn-sm"
              ng-class="{ active: selectedLang === 'en' }"
              ng-click="switchLang('en')"
            >
              EN
            </button>
            <button
              type="button"
              class="btn btn-outline-light btn-sm"
              ng-class="{ active: selectedLang === 'it' }"
              ng-click="switchLang('it')"
            >
              IT
            </button>
          </div>
        </div>
      </div>

      <!-- Main wrapper -->
      <div
        class="page-container d-flex"
        ng-class="{ 'sidebar-open': showFilterPanel }"
      >
        <!-- Filters sidebar -->
        <div class="filters-panel" ng-class="{ open: showFilterPanel }">
          <h3>{{ labels['filters.header'] }}</h3>

          <label>
            {{ labels['task.filters.description'] }}
            <input type="text" ng-model="activeFilters.description" />
          </label>

          <div class="my-2">
            {{ labels['task.filters.status'] }}
            <div class="form-check form-switch">
              <input
                type="checkbox"
                class="form-check-input"
                ng-model="activeFilters.statusMap.TODO"
                id="filterTodo"
              />
              <label class="form-check-label" for="filterTodo">TODO</label>
            </div>
            <div class="form-check form-switch">
              <input
                type="checkbox"
                class="form-check-input"
                ng-model="activeFilters.statusMap['IN PROGRESS']"
                id="filterProgress"
              />
              <label class="form-check-label" for="filterProgress"
                >IN PROGRESS</label
              >
            </div>
            <div class="form-check form-switch">
              <input
                type="checkbox"
                class="form-check-input"
                ng-model="activeFilters.statusMap.DONE"
                id="filterDone"
              />
              <label class="form-check-label" for="filterDone">DONE</label>
            </div>
          </div>

          <label>
            {{ labels['task.filters.assignee'] }}
            <select
              class="form-select"
              ng-model="activeFilters.assigneeId"
              ng-options="user.id as user.fullName for user in assigneeList"
            >
              <option value="">
                {{ labels['task.filters.allAssignees'] }}
              </option>
            </select>
          </label>

          <button
            class="btn btn-primary mt-3"
            ng-if="filterMode !== 'client'"
            ng-click="applyFilters()"
          >
            {{ labels['filters.apply'] }}
          </button>
        </div>

        <!-- Main content -->
        <div class="main-content flex-grow-1 p-4">
          <div class="spinner-container" ng-show="isLoading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <ul class="task-list" ng-hide="isLoading">
            <li
              class="task-item"
              ng-attr-data-status="{{ cssStatus(task) }}"
              ng-repeat="task in getFilteredTasks()"
            >
              <!-- Top line: description + action buttons -->
              <div class="d-flex justify-content-between align-items-start">
                <span class="fw-semibold">{{ task.description }}</span>

                <div class="btn-group btn-group-sm" role="group">
                  <button
                    class="btn btn-outline-secondary"
                    ng-click="openTaskModal(task)"
                    title="{{ labels['task.edit'] }}"
                  >
                    <span class="icon-action text-secondary">
                      <i class="bi bi-pencil icon-action"></i>
                    </span>
                  </button>

                  <button
                    class="btn btn-outline-primary"
                    ng-click="nextStatus(task)"
                    ng-disabled="task.status === 'DONE'"
                    title="{{ labels['task.nextStatus'] }}"
                  >
                    <span class="icon-action text-primary">
                      <i class="bi bi-forward icon-action"></i>
                    </span>
                  </button>

                  <button
                    class="btn btn-outline-danger"
                    ng-click="openConfirmModal(task)"
                    title="{{ labels['task.delete'] }}"
                  >
                    <span class="icon-action text-danger">
                      <i class="bi bi-trash icon-action"></i>
                    </span>
                  </button>
                </div>
              </div>

              <!-- Lower line: assignee + status -->
              <div class="d-flex justify-content-between mt-1 text-muted small">
                <span>{{ userMap[task.assigneeId] || '—' }}</span>
                <span class="badge rounded-pill bg-secondary status-badge">
                  {{ task.status }}
                </span>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <modal-container
        is-visible="showTaskModal"
        on-cancel="clearTaskModal()"
        auto-focus="true"
      >
        <form ng-submit="saveTask()">
          <h5 class="modal-title">
            {{ modalTask.id ? labels['task.modal.title.edit'] :
            labels['task.modal.title.create'] }}
          </h5>

          <div class="mb-3">
            <label class="form-label"
              >{{ labels['task.modal.field.description'] }}</label
            >
            <input
              type="text"
              class="form-control"
              ng-model="modalTask.description"
              required
            />
          </div>

          <div class="mb-3">
            <label class="form-label"
              >{{ labels['task.modal.field.status'] }}</label
            >
            <select class="form-select" ng-model="modalTask.status" required>
              <option value="TODO">TODO</option>
              <option value="IN PROGRESS">IN PROGRESS</option>
              <option value="DONE">DONE</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label"
              >{{ labels['task.modal.field.assignee'] }}</label
            >
            <select
              class="form-select"
              ng-model="modalTask.assigneeId"
              ng-options="user.id as user.fullName for user in assigneeList"
            >
              <option value="">
                {{ labels['task.modal.assignee.placeholder'] }}
              </option>
            </select>
          </div>

          <div class="modal-footer mt-3 d-flex justify-content-end gap-2">
            <button
              type="button"
              class="btn btn-outline-secondary"
              ng-click="clearTaskModal()"
            >
              {{ labels['task.modal.button.cancel'] }}
            </button>
            <button type="submit" class="btn btn-primary">
              {{ modalTask.id ? labels['task.modal.button.update'] :
              labels['task.modal.button.save'] }}
            </button>
          </div>
        </form>
      </modal-container>

      <!-- Delete confirm modal -->
      <modal-container
        is-visible="showConfirmModal"
        on-cancel="cancelDelete()"
        on-confirm="deleteTask()"
        auto-focus="true"
      >
        <div>
          <p class="mb-3">{{ labels['task.delete.confirm'] }}</p>
          <div class="modal-footer d-flex justify-content-end gap-2">
            <button
              type="button"
              class="btn btn-outline-secondary"
              ng-click="cancelDelete()"
            >
              {{ labels['button.cancel'] }}
            </button>
            <button
              type="button"
              class="btn btn-danger"
              ng-click="deleteTask()"
            >
              {{ labels['button.confirm'] }}
            </button>
          </div>
        </div>
      </modal-container>
    </div>
  </body>
</html>
